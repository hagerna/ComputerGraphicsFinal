<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>WebGL Texturing</title>
</head>
<body>
	<canvas width="500" height="500" id="webgl-canvas"></canvas>

    <script src="../common/webgl-debug.js"></script>
    <script src="../common/math.js"></script>
    <script src="../common/gl-utils.js"></script>
    <script src="../common/input.js"></script>
    <script src="../common/renderloop.js"></script>
    <script src="../common/camera.js"></script>
    <script src="../common/grid.js"></script>
    <script src="../common/dat.gui.min.js"></script>
    <script src="../common/stats.min.js"></script>
    <script src="../common/objparser.js"></script>

    <script src="renderer.js"></script>
    <script src="pointLightRenderer.js"></script>
    <script src="unlitRenderer.js"></script>
    <script src="skyBox.js"></script>
    <script src="modeltransform.js"></script>
    <script src="primitives.js"></script>

    <script src="howler.js"></script>

    <button id="startbutton" width="300" height="300" onclick="load()" style="
        background-color: #111111; border: none; color: white; padding: 50px 50px; text-align: center;
        text-decoration: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        font-size: 50px;">Click here to start your journey!</button>


    <script type="text/javascript">
        "use strict"; // use strict javascript compiling

        //--------------------------------------------------
        // Global Cashes
        //--------------------------------------------------
        var MeshCache = {}; // here all mesh objects are stored, see GLUtils.createMesh() for details on how a mesh is added.
        var TextureCache = {}; // here all texture objects are stored, see GLUtils.loadTexture() for details on how a texture is added.

        // -----------------------------------------
        // Global variables
        // -----------------------------------------
        var gl;
        var canvas;
        var renderLoop;

        var g_camera;
        var g_cameraController;

        var sphere, cylinder, pyramid, cube, quad, skyBox, star, asteroid;

        var g_renderer, g_skyBox_renderer, g_pointLightRenderer, g_unlitRenderer;

        var timer = 0;
        var music;

        var gui_data = {mute: false};
        var gui = new dat.GUI({ width: 100 } );
        gui.add(gui_data, "mute").onChange(function(value){music?.mute(value);});

        // lighting
        var g_lightingData = {
            directionalLight: new V3(-0.2, -0.5, -0.5).normalize(), // light direction
            directionalColor: new V3(1.0, 1.0, 1.0), // light color by default white
            ambientColor: new V3(0.2, 0.2, 0.2), // dark gray
            pointLight: new V3(2,3,0), // point light position
            pointLightColor: new V3(0.98, 0.46, 0), // point light color
        };

        function setup(){
            canvas = document.getElementById("webgl-canvas");
            gl = GLUtils.createWebGLInstance(canvas, true);
            gl.clearColor(0.85, 0.95, 0.9, 1); // set clear color (RGBA)
            gl.fitScreen();
            gl.enable(gl.DEPTH_TEST);
            gl.depthFunc(gl.LEQUAL);

            // our shader files are loaded here. Once completed, init is called
            // for now there is only the standardShader, but you can add more by
            // simply adding another path into the array shaderPaths.
            let shaderPaths = ["shaders/standardShader.glsl", "shaders/skyBoxShader.glsl", "shaders/pointLightShader.glsl", "shaders/unlitShader.glsl"]; 
            GLUtils.loadShaders(shaderPaths, init);
        }

        function init(){
            Input.initialize(canvas);

            music = new Howl({
                src: ['resources/Space Exploration Song.mp3'],
                html5: true, // use streaming audio if possible
                loop: true
            });
            music.play();
            music.mute(gui_data.mute);

            g_renderer = new Renderer("standardShader");
            g_pointLightRenderer = new PointLightRenderer("pointLightShader");
            g_unlitRenderer = new UnlitRenderer("unlitShader");

           GLUtils.loadCubeMap("skyBox","resources/bkg1_right.png","resources/bkg1_left.png", "resources/bkg1_top.png", "resources/bkg1_bot.png", "resources/bkg1_front.png", "resources/bkg1_back.png"); 
       
            g_camera = new PerspectiveCamera(45, 0.1, 1000, canvas.width / canvas.height);
            g_cameraController = new InputCameraController(canvas, g_camera);
            g_cameraController.target.set(0,0,0);

            skyBox = new SkyBox("skyBoxShader", "skyBox", g_camera); 

            //TODO: load texture from resources folder to TextureCache
            //TODO: add mainTexture property with loaded texture to material
            GLUtils.loadTexture("uv-test", "resources/uv-test.png");
            GLUtils.loadTexture("burning-steel", "resources/burning-steel.png");
            GLUtils.loadTexture("gas-planet", "resources/Gas-Giant.png");
            GLUtils.loadTexture("asteroid", "resources/asteroid.png");
            // load space box texture

            // Material with white tint color
            let uvTestMat = {tint: new V3(1,1,1), mainTexture: "uv-test"};
            let starMat = {tint: new V3(1,1,1), mainTexture: "burning-steel"};
            let starMatCyan = {tint: new V3(1,1,0), mainTexture: "burning-steel"};
            let gasGiantMat = {tint: new V3(1,1,1), mainTexture: "gas-planet"};
            let AsteroidMat = {tint: new V3(1,1,0), mainTexture: "asteroid"};

            let Asteroid1Mesh = OBJLoader.getMesh("Asteroid1Mesh", "resources/Asteroid1.obj");
            asteroid = new ModelTransform(Asteroid1Mesh, AsteroidMat);

            sphere = new ModelTransform(Primitives.Sphere.getMesh(), gasGiantMat);
            cylinder = new ModelTransform(Primitives.Cylinder.getMesh(), starMat);
            pyramid = new ModelTransform(Primitives.Pyramid.getMesh(), starMat);
            star = new ModelTransform(Primitives.Sphere.getMesh(), starMatCyan);

            sphere.position.set(1.5,0,-1.5);
            cylinder.position.set(-1.5,0,-1.5);
            pyramid.position.set(1.5,0.5,1.5);
            star.position.set(0,0,-10);
            star.scale.set(3,3,3);

            renderLoop = new RenderLoop(draw).start();
        }

        function draw(deltaTime){
            Input.update();
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
            g_cameraController.update();
            timer += deltaTime;
            sphere.ConstantRotate(8,timer);
            sphere.Orbit(star.position, 10, 1, timer);
            star.ConstantRotate(2,timer);
            asteroid.Orbit(star.position, 12, 2, timer);
            sphere.update();
            cylinder.update();
            pyramid.update();
            star.update();      

            let shaderData = { lightingData: g_lightingData};

            skyBox.drawGeometry(g_camera);
            g_renderer.drawModel(sphere, g_camera, shaderData);
            g_renderer.drawModel(asteroid, g_camera, shaderData);
            g_pointLightRenderer.drawModel(cylinder, g_camera, shaderData);
            g_pointLightRenderer.drawModel(pyramid, g_camera, shaderData);
            g_unlitRenderer.drawModel(star, g_camera, shaderData);
        
            gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);

            gl.enable(gl.CULL_FACE);
            gl.enable(gl.DEPTH_TEST);
        }

        function load(){
            var button = document.getElementById("startbutton");
            button.remove();
            setup();
        }
    </script>
</body>
</html>
